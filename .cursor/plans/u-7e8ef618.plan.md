<!-- 7e8ef618-a1eb-4561-9e12-4775b229558d 254be028-8f41-4d52-abff-f98d1df50728 -->
# Fix Attachment and Dependency Generation Issues

## Problem Summary

1. **Attachments not generated** - Filter is too restrictive, blocking nodes with figure/table mentions
2. **Attachment format mismatch** - Stored format doesn't match what tree building expects  
3. **Dependencies may fail silently** - Title matching needs verification and better error handling

---

## Fix #1: Remove Restrictive Filter for Attachment Resolution

**Location:** `lib/processing/ai-synthesis-pipeline.ts` lines 479-493

**Current Problem:**

- Filter only processes nodes if they already have attachments OR mention document topics
- Nodes mentioning "Figure 1" but not containing section title keywords are filtered out
- Result: `resolveAttachments()` never called, so figures/tables never detected

**Fix:**

Replace the restrictive filter with logic that processes ALL nodes for ALL documents, or at minimum checks for figure/table mentions before filtering.

**Implementation:**

```typescript
// Process ALL nodes for ALL documents (simple and reliable)
const nodesForDoc = allProposedNodes;
```

OR if we want to keep some filtering for performance:

```typescript
const nodesForDoc = allProposedNodes.filter(n => {
  // Always process if node mentions figures/tables (HIGH PRIORITY)
  const mentionsFigures = /\b(fig\.?|figure)\s*\d+/i.test(n.content.text);
  const mentionsTables = /\btable\s*\d+/i.test(n.content.text);
  
  if (mentionsFigures || mentionsTables) {
    return true; // Process this node
  }
  
  // Also process if already has attachments (for validation)
  const hasAttachmentsForDoc = n.attachments.some(a => a.sourceId === structuredDoc.sourceId);
  if (hasAttachmentsForDoc) {
    return true;
  }
  
  // Optional: Process if content mentions document topics (for other attachments)
  const hasNoAttachments = n.attachments.length === 0;
  if (hasNoAttachments) {
    const docTopics = extractTopicsFromDocument(structuredDoc);
    const contentMentionsDoc = docTopics.some(topic => 
      n.content.text.toLowerCase().includes(topic.toLowerCase())
    );
    if (contentMentionsDoc) {
      return true;
    }
  }
  
  return false; // Skip nodes that don't match any criteria
});
```

**Recommendation:** Use the simpler approach (process ALL nodes) to ensure nothing is missed.

---

## Fix #2: Fix Attachment Storage Format Mismatch

**Location 1:** `lib/processing/ai-synthesis-pipeline.ts` lines 574-578 (storing in proposals)

**Current Format:**

```typescript
attachments: node.attachments.map(att => ({
  id: att.sourceId,           // ❌ Wrong field name
  name: att.fileName,          // ✅ Correct
  range: att.pageRange ? `${att.pageRange[0]}-${att.pageRange[1]}` : undefined,  // ❌ Wrong format
}))
```

**Location 2:** `app/api/projects/[projectId]/proposals/route.ts` lines 1221-1232 (reading from proposals)

**Expected Format:**

```typescript
{
  name: attachment.name || 'Untitled Attachment',
  file_type: attachment.file_type || '',
  file_size: attachment.file_size || 0,
  file_url: attachment.file_url || '',
  description: attachment.description || '',
}
```

**Fix:**

Update storage format to include all fields tree building expects, and preserve pageRange information.

**Implementation:**

```typescript
attachments: node.attachments.map(att => ({
  name: att.fileName || `Attachment from ${att.sourceId}`,
  file_type: structuredDoc.type === 'pdf' ? 'pdf' : structuredDoc.type || 'unknown',
  file_size: 0, // Not available from attachment resolver, but tree building expects it
  file_url: '', // Could generate URL or leave empty for now
  description: att.relevance || `Contains ${att.relevance || 'attachment'}`,
  pageRange: att.pageRange, // Store as [number, number] array for reference
  sourceId: att.sourceId, // Keep for reference
})),
```

**Note:** `file_url` and `file_size` may need to be populated later or left empty if not available at this stage.

---

## Fix #3: Improve Dependency Title Matching and Logging

**Location:** `app/api/projects/[projectId]/proposals/route.ts` lines 1044-1062

**Current Issue:**

- Dependencies exist in proposals but may fail to match during tree building
- No logging when title matching fails
- Silent failures make debugging impossible

**Fix:**

Add comprehensive logging and fuzzy matching fallbacks.

**Implementation:**

```typescript
// Extract dependencies from proposals
for (const createdNode of createdTreeNodes) {
  const proposal = createdNode.provenance?.proposal_id 
    ? sortedProposals.find(p => p.id === createdNode.provenance.proposal_id)
    : null;

  if (proposal && proposal.node_json?.dependencies && Array.isArray(proposal.node_json.dependencies)) {
    console.log(`[BUILD_TREE] Processing ${proposal.node_json.dependencies.length} dependencies for node "${createdNode.name}"`);
    
    for (const dep of proposal.node_json.dependencies) {
      const referencedTitle = dep.referenced_title || dep.referencedNodeTitle;
      if (!referencedTitle) {
        console.warn(`[BUILD_TREE] Dependency missing referenced_title:`, dep);
        continue;
      }

      // Try exact match first
      let referencedNodeId = nodeTitleToIdMap.get(referencedTitle.toLowerCase());
      
      // If exact match fails, try fuzzy matching (remove punctuation, normalize whitespace)
      if (!referencedNodeId) {
        const normalizedTitle = referencedTitle.toLowerCase()
          .replace(/[^\w\s]/g, '')
          .replace(/\s+/g, ' ')
          .trim();
        
        for (const [title, nodeId] of nodeTitleToIdMap.entries()) {
          const normalizedMapTitle = title
            .replace(/[^\w\s]/g, '')
            .replace(/\s+/g, ' ')
            .trim();
          
          if (normalizedMapTitle === normalizedTitle || 
              normalizedMapTitle.includes(normalizedTitle) ||
              normalizedTitle.includes(normalizedMapTitle)) {
            referencedNodeId = nodeId;
            console.log(`[BUILD_TREE] Fuzzy matched "${referencedTitle}" to "${title}"`);
            break;
          }
        }
      }
      
      if (!referencedNodeId) {
        console.warn(
          `[BUILD_TREE] ⚠️  Could not find node for dependency: "${referencedTitle}" ` +
          `(from node "${createdNode.name}")`
        );
        console.warn(`[BUILD_TREE] Available node titles (first 5):`, 
          Array.from(nodeTitleToIdMap.keys()).slice(0, 5)
        );
        continue;
      }
      
      if (referencedNodeId && referencedNodeId !== createdNode.id) {
        dependencyEntries.push({
          from_node_id: createdNode.id,
          to_node_id: referencedNodeId,
          dependency_type: dep.dependency_type || dep.dependencyType || 'requires',
          evidence_text: dep.extractedPhrase || dep.evidence || '',
          confidence: dep.confidence || 0.8,
        });
        console.log(
          `[BUILD_TREE] ✅ Matched dependency: "${createdNode.name}" -> "${nodeTitleToIdMap.get(referencedTitle.toLowerCase()) || 'unknown'}"`
        );
      }
    }
  }
}
```

---

## Implementation Order

1. **Fix #1 (Remove restrictive filter)** - Highest priority, enables attachment detection
2. **Fix #2 (Fix storage format)** - Required for attachments to transfer to tree nodes
3. **Fix #3 (Improve dependency matching)** - Improves reliability and debuggability

---

## Testing Strategy

After fixes:

1. **Test attachments:**

   - Re-run import on test document
   - Check proposals have attachments: `SELECT node_json->'attachments' FROM proposed_nodes WHERE ...`
   - Check tree nodes have attachments: `SELECT * FROM node_attachments WHERE ...`
   - Verify figures/tables are linked

2. **Test dependencies:**

   - Check proposals have dependencies: `SELECT node_json->'dependencies' FROM proposed_nodes WHERE ...`
   - Check tree nodes have dependencies: `SELECT * FROM node_dependencies WHERE ...`
   - Verify title matching works (check logs for warnings)

3. **Verify logs:**

   - Check console for `[ATTACHMENT]` messages showing figures/tables found
   - Check console for `[BUILD_TREE]` messages showing dependency matching
   - Check for any warnings about failed matches

### To-dos

- [x] 
- [x] 
- [x] 